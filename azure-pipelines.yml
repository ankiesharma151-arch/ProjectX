trigger:
- main

pool:
  name: Default   # self-hosted agent (Siri)

variables:
  TF_VERSION: '1.6.6'
  TF_WORKING_DIR: 'terraform'   # change if your tf files are in root

stages:
- stage: Terraform
  displayName: Terraform CI/CD
  jobs:
  - job: TerraformJob
    displayName: Terraform Init Plan Apply
    steps:

    # Checkout code
    - checkout: self

    # Install Terraform
    - task: PowerShell@2
      displayName: Install Terraform
      inputs:
        targetType: inline
        script: |
          choco install terraform --version $(TF_VERSION) -y
          terraform -version

    # Terraform Init
    - task: PowerShell@2
      displayName: Terraform Init
      inputs:
        targetType: inline
        workingDirectory: $(TF_WORKING_DIR)
        script: |
          terraform init

    # Terraform Validate
    - task: PowerShell@2
      displayName: Terraform Validate
      inputs:
        targetType: inline
        workingDirectory: $(TF_WORKING_DIR)
        script: |
          terraform validate

    # Terraform Plan
    - task: PowerShell@2
      displayName: Terraform Plan
      inputs:
        targetType: inline
        workingDirectory: $(TF_WORKING_DIR)
        script: |
          terraform plan -out=tfplan

    # Terraform Apply (DISABLED)
    - task: PowerShell@2
      displayName: Terraform Apply (Disabled)
      condition: false   # ðŸ‘ˆ Apply will NEVER run
      inputs:
        targetType: inline
        workingDirectory: $(TF_WORKING_DIR)
        script: |
          terraform apply -auto-approve tfplan

